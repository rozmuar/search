# Архитектура системы

## Обзор компонентов

### 1. Личный кабинет (Admin Panel)

Веб-интерфейс для управления проектами поиска.

```
┌─────────────────────────────────────────────────────────────┐
│                    ЛИЧНЫЙ КАБИНЕТ                            │
├─────────────────────────────────────────────────────────────┤
│  • Регистрация/авторизация пользователей                    │
│  • Создание проектов (сайтов)                               │
│  • Настройка фидов (URL, интервал обновления)               │
│  • Получение API ключа и кода виджета                       │
│  • Просмотр статистики поиска                               │
│  • Настройка синонимов и стоп-слов                          │
│  • Настройка внешнего вида виджета                          │
└─────────────────────────────────────────────────────────────┘
```

### 2. API Gateway

Единая точка входа для всех запросов.

```
┌─────────────────────────────────────────────────────────────┐
│                      API GATEWAY                             │
├─────────────────────────────────────────────────────────────┤
│  Функции:                                                    │
│  • Аутентификация по API ключу                              │
│  • Rate limiting (ограничение запросов)                     │
│  • CORS для виджета                                         │
│  • Кэширование популярных запросов                          │
│  • Маршрутизация к микросервисам                            │
│  • Логирование и метрики                                    │
└─────────────────────────────────────────────────────────────┘
```

### 3. Search Service

Ядро поисковой системы.

```
┌─────────────────────────────────────────────────────────────┐
│                    SEARCH SERVICE                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Query Processor                         │    │
│  │  • Нормализация запроса                              │    │
│  │  • Токенизация                                       │    │
│  │  • Исправление опечаток                              │    │
│  │  • Применение синонимов                              │    │
│  └─────────────────────────────────────────────────────┘    │
│                          │                                   │
│                          ▼                                   │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Search Executor                         │    │
│  │  • Поиск по инвертированному индексу                │    │
│  │  • Поиск по n-gram (частичное совпадение)           │    │
│  │  • Фильтрация по наличию/цене                       │    │
│  │  • Ранжирование результатов                         │    │
│  └─────────────────────────────────────────────────────┘    │
│                          │                                   │
│                          ▼                                   │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Result Formatter                        │    │
│  │  • Подсветка совпадений                             │    │
│  │  • Пагинация                                        │    │
│  │  • Формирование ответа                              │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 4. Indexer Service

Сервис обработки и индексации фидов.

```
┌─────────────────────────────────────────────────────────────┐
│                    INDEXER SERVICE                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌───────────────────────┐  ┌───────────────────────┐       │
│  │   Full Feed Worker    │  │  Delta Feed Worker    │       │
│  │                       │  │                       │       │
│  │  • Загрузка полного   │  │  • Загрузка фида     │       │
│  │    фида товаров       │  │    остатков/цен      │       │
│  │  • Парсинг XML/JSON   │  │  • Быстрое обновление│       │
│  │  • Валидация данных   │  │    без переиндексации│       │
│  │  • Полная переиндекс. │  │                       │       │
│  └───────────────────────┘  └───────────────────────┘       │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  Index Builder                       │    │
│  │  • Токенизация названий/описаний                    │    │
│  │  • Построение инвертированного индекса              │    │
│  │  • Построение n-gram индекса                        │    │
│  │  • Расчёт весов для ранжирования                    │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 5. Scheduler Service

Планировщик задач обновления.

```
┌─────────────────────────────────────────────────────────────┐
│                   SCHEDULER SERVICE                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Задачи:                                                     │
│  • Периодическое обновление полных фидов (1-24 часа)        │
│  • Частое обновление delta-фидов (5-30 минут)               │
│  • Мониторинг доступности фидов                             │
│  • Уведомления об ошибках                                   │
│                                                              │
│  Приоритеты:                                                 │
│  • Delta фиды — высокий приоритет                           │
│  • Полные фиды — обычный приоритет                          │
│  • Балансировка нагрузки                                    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## Хранилища данных

### PostgreSQL — основная БД

```sql
-- Пользователи системы
users
  - id
  - email
  - password_hash
  - created_at

-- Проекты (сайты)
projects
  - id
  - user_id
  - name
  - domain
  - api_key
  - settings (JSON)
  - created_at

-- Настройки фидов
feeds
  - id
  - project_id
  - type (full/delta)
  - url
  - format (xml/json)
  - update_interval
  - last_update
  - last_status
  - items_count

-- Синонимы
synonyms
  - id
  - project_id
  - word
  - synonyms[]

-- Стоп-слова
stopwords
  - id
  - project_id
  - word
```

### Redis — кэш и индексы

```
Структуры данных:

# Товары проекта
products:{project_id}:{product_id} = {JSON товара}

# Инвертированный индекс (слово -> товары)
idx:{project_id}:inv:{token} = ZSET {product_id: score}

# N-gram индекс для автодополнения
idx:{project_id}:ngram:{ngram} = SET {tokens}

# Кэш популярных запросов
cache:{project_id}:q:{query_hash} = {JSON результатов}

# Статистика запросов
stats:{project_id}:queries = ZSET {query: count}
```

### Elasticsearch (опционально)

Для крупных проектов с большим количеством товаров.

```json
{
  "mappings": {
    "properties": {
      "id": { "type": "keyword" },
      "name": { 
        "type": "text",
        "analyzer": "russian",
        "fields": {
          "suggest": { "type": "completion" },
          "ngram": { "type": "text", "analyzer": "ngram_analyzer" }
        }
      },
      "description": { "type": "text", "analyzer": "russian" },
      "category": { "type": "keyword" },
      "price": { "type": "float" },
      "old_price": { "type": "float" },
      "in_stock": { "type": "boolean" },
      "quantity": { "type": "integer" },
      "image": { "type": "keyword" },
      "url": { "type": "keyword" },
      "popularity": { "type": "float" }
    }
  }
}
```

## Потоки данных

### 1. Добавление нового проекта

```
Пользователь                Admin Panel              API              Database
     │                           │                    │                   │
     │──── Создать проект ──────▶│                    │                   │
     │                           │                    │                   │
     │                           │─── POST /projects ─▶│                   │
     │                           │                    │                   │
     │                           │                    │─── INSERT ───────▶│
     │                           │                    │                   │
     │                           │                    │◀── OK ────────────│
     │                           │                    │                   │
     │                           │◀── API Key ────────│                   │
     │                           │                    │                   │
     │◀─── Код виджета ──────────│                    │                   │
```

### 2. Обновление полного фида

```
Scheduler          Indexer           Feed URL          Redis/ES         DB
    │                 │                  │                 │              │
    │── Trigger ─────▶│                  │                 │              │
    │                 │                  │                 │              │
    │                 │── GET feed ─────▶│                 │              │
    │                 │                  │                 │              │
    │                 │◀── XML/JSON ─────│                 │              │
    │                 │                  │                 │              │
    │                 │── Parse & Index ────────────────────▶│              │
    │                 │                  │                 │              │
    │                 │── Update status ───────────────────────────────────▶│
    │                 │                  │                 │              │
```

### 3. Поисковый запрос

```
Widget             API Gateway         Search Service        Redis
   │                    │                    │                  │
   │── GET /search ────▶│                    │                  │
   │                    │                    │                  │
   │                    │── Validate Key ───▶│                  │
   │                    │                    │                  │
   │                    │                    │── Check cache ──▶│
   │                    │                    │                  │
   │                    │                    │◀── Cache miss ───│
   │                    │                    │                  │
   │                    │                    │── Search index ─▶│
   │                    │                    │                  │
   │                    │                    │◀── Results ──────│
   │                    │                    │                  │
   │                    │                    │── Save cache ───▶│
   │                    │                    │                  │
   │                    │◀── JSON results ───│                  │
   │                    │                    │                  │
   │◀── Results ────────│                    │                  │
```

## Требования к производительности

| Метрика | Целевое значение |
|---------|------------------|
| Время ответа поиска | < 50ms (p95) |
| Время ответа подсказок | < 30ms (p95) |
| Обновление delta-фида | < 1 минута |
| Индексация 100K товаров | < 5 минут |
| Доступность | 99.9% |

## Масштабирование

```
                    Load Balancer
                         │
          ┌──────────────┼──────────────┐
          │              │              │
     ┌────▼────┐   ┌────▼────┐   ┌────▼────┐
     │ API #1  │   │ API #2  │   │ API #3  │
     └────┬────┘   └────┬────┘   └────┬────┘
          │              │              │
          └──────────────┼──────────────┘
                         │
                  Redis Cluster
                  (Master + Replicas)
```
